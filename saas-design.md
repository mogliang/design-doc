# SAAS设计

SAAS软件与传统独立部署软件存在很多差异，SAAS软件具有无需本地部署，开箱即用，持续更新等优点。 在商业模式上，有别于传统软件1次付费，SAAS采用订阅收费模式。另外，根据国内SAAS产业的现状来看，大型SAAS租户最终仍然期望能提供独立部署和定制化开发。SAAS软件的特征，为SAAS服务架构、运维管理以及运营提出诸多挑战。

本文并非是要给出SAAS的设计方案，而是把SAAS需要考虑的各个方面罗列出来，读者可以根据实际业务特征，提出正确的问题，把握好前进的方向。


    • 业务领域

    • saas基础支撑
        ○ 多租户(tenant)
            § 独立域名
            § 租户隔离
        ○ 功能/版本开关管理
        ○ tenant管理
            § tenant创建/初始化

    • 账户系统
        ○ 多账户类型
        ○ 身份代理
        ○ 权限管理

    • 运维
        ○ 版本发布
            § 停机机制
        ○ 环境管理
        ○ 服务监控
            § 日志收集
            § 流程自动化
        ○ tenant监控
        ○ tenant迁移
        ○ tenant合并/拆分

    • 独立部署管理
        ○ 基础设施抽象
        ○ 独立部署基础设施
        ○ 数据安全

    • 数据运营
        ○ 各种报表（活跃度等，收支，功能使用度）
		
## 业务领域
业务领域是产品的核心，是剥离SAAS软件形态后存粹的业务逻辑。此领域一般不包含SAAS相关的设计细节

## SAAS基础支撑
SAAS基础支撑满足SAAS软件形态的需求，把SAAS的处理逻辑封装在本层，而对上层业务领域提供简单抽象的接口。以租户隔离为例，当浏览器请求到达服务器时，基础支撑层需要完成，定位租户，连接租户数据库/文件目录，并对数据读写操作添加租户边界限制条件等，而作为上层业务领域，无需再在乎租户概念。

### 多租户设计
多租户的设计目标是多个租户同时使用一套公有云的服务部署，每个租户都感觉在独占使用系统。这里有多个方面：
1. 每个租户的地址分离
2. 租户页面定制化（比如登录欢迎页，logo）
3. 后台服务在处理请求时，能严格隔离不同租户的访问数据。

除了功能和数据上的隔离，另外还要防止相互挤占资源，包括存储空间，网络带宽，计算资源，内存等。SAAS底层架构可以对资源使用进行量化，并加以限制。

### 功能/版本开关
由于来自客户定制化的需求，Beta测试，以及市场部门对产品阶梯定价的需求，SAAS系统需要有很完备的功能/版本开关管理。在设计过程中，要充分考虑到如下因素：
1. 功能模块的依赖关系需要一开始就梳理好，最好通过元数据管理直接在代码层面进行标注。
2. 功能开关的粒度需要准确把控，不要产生交叉，尽量保持独立性（无相互依赖，互斥），也最好不要出现没有完整业务含义的开关（避免复杂的功能开关组合）。
3. 开关意味着更多的测试内容，测试用例要确保覆盖各种可能的组合。

在软件持续开发过程中，功能开关需要谨慎添加，否则系统复杂度会快速升高，导致系统很难维护。换句话说，需要谨慎筛选来自客户的定制化需求。

### Tenant管理
使用"Tenant管理"的角色主要是客户成功经理，他需要负责创建租户，初始化租户模板数据，以及一些数据修复工作。Tenant管理操不同于用户操作，不带Tenant标识，可以进行跨tenant的数据访问操作。设计这部分功能时需要注意：
- 任何操作都要有记录，关键操作需要审批
- 数据接入层需要为tenant管理留有接口进行跨tenant操作。

### API管理
SAAS系统对外提供API接口是很有必要的。客户需要利用API来做系统集成，更加深度的使用服务。而对于SAAS厂商，系统集成可以提高服务粘性，有助于保留客户。不过SAAS服务的API设计面临一些难题：
1. 不同的客户对API需求不一样，SAAS要用一套系统尽量满足所有客户的需求。
2. 服务持续更新，业务模型可能产生变化，对应的API接口也会改变，潜在的会影响到客户的集成系统。
3. 滥用API会消耗很多资源，从而影响到其他客户。

在开发API时，研发团队一定要谨慎，API接口开发可能不复杂，但是后续维护的成本非常高。研发团队尽量避免客户定制API需求，而应该根自己稳定的据领域模型来设计API。如果领域模型不稳定，那就宁可不提供API。
另外，API基础架构需要足够强壮，支持租户隔离，限流，API versioning，审计，Metrics。

### 账户系统
SAAS系统的账户至少有两类：租户账户和系统账户。
- 租户账户就是客户所使用的登录账户，权限边界为归属租户。
- 系统账户是操作“Tenant管理”的账户，一般是客户成功经理使用。

除此之外，可能还会有
- 合作伙伴账户。当SAAS系统外部对接越来越多时，需要搭建一个开放平台为第三方提供接入服务，此时会需要合作伙伴账户来标识第三方身份。租户和第三方直接可能存在授权关系，可通过OAuth实现。
- 消费者账户。在一些业务领域，租户有管理和连接他们企业的客户的需求，SAAS系统可以为此类用户单独提供一类账户，此类账户可以访问特定服务和权限。

在设计账户管理子系统时，要注意：
- 账户管理是整个SAAS最基础的服务之一，随着业务发展，会出现越来越多的子系统（CRM，微信小程序，H5营销页，APP），功能完整的账户系统将会大大简化后续子系统的开发。
- 在底层把每类账户的权限边界划分清楚，避免出现跨界访问。
- 留意账户之间的授权/代理逻辑的设计， 如租户用户授权客户经理临时登录他的系统进行操作，租户把档案的读写操作授权给第三方，由第三方提供增值服务。
- 把系统的攻击平面尽量缩小。避免因各种原因绕开账户子系统，做临时登录方案。

## 运维
SAAS系统的重要优势就是客户不需运维，而是由SAAS厂商负责集中运维。这就对SAAS运维提出了很高的要求：大规模集群，准确监控，及时响应，高度自动化。运维团队需要把系统设计和流程管理相结合来应对挑战，而下文主要针对系统设计进行分析。

### 版本发布
不同领域的客户对服务停机有不同的容忍度，有的行业能够允许非工作时间停机，有的允许事先约定时间窗口，也有的行业要求24小时不停歇工作。这点是对SAAS软件非常强的约束条件，一定要在软件开发最初期即调研清楚，并在系统底层进行实现，后期再调整需求往往成本高昂或者不切实际。

### 环境管理
为了故障隔离，安全隔离或独立部署等要求，以及各种测试需求，运维团队往往要同时管理很多环境。不同环境又连接到不同的外围系统。这里面的关系以及配置非常繁杂，容易出现人为生产事故。为了解决问题，可以通过引入一套自动化流程，集成项目管理工具+代码管理工具+CodeReview对环境操作进行规范化。

### 服务监控
服务日志和Metrics是衡量服务健康状态的重要依据，它能客观反映客户使用系统的真实感受。另外，当出现产品功能问题，或者网络攻击时，日志是分析问题的重要线索。因此运维团队必须要充分管理这些数据。

SAAS租户规模越大，服务部署规模就越大，每日产生的日志和Metrics非常多且分散。业界有成熟的分布式系统日志收集方案，如ELK。日志收集后，还需要进一步做自动化，如：Metrics 预警，自动规则响应，集成工单系统。需要注意的是，Metrics以及预警规则的制定必须要研发团队和运维团队一起商讨并达成共识。失真的Metrics不能代表客户真实的使用体验，而过于宽松或敏感的预警会让自动化流程不能产生效益，却带来更多负担。

### Tenant监控
多租户在使用SAAS服务时，系统要确保租户间不会相互挤占服务器资源。除了在SAAS架构底层对资源使用进行控制，运行时的实时监控和限制措施是非常必要的。运维团队可以利用服务网关来监测和管控租户的服务使用，以及应对各种突发事件。

## 独立部署管理
独立部署是SAAS公司经常面对的客户需求。独立部署相当于给产品增加一个新维度(切面），它会影响产品的各个方面。

### 基础设施抽象层
通常情况下，客户的数据中心和SAAS公有云环境是异构的，SAAS服务很难直接部署在各种异构的基础设施上，因此需要引入基础设施抽象层。对计算资源的抽象可以使用容器服务，如k8s。对象数据以及中间件服务（如队列，搜索服务）可以通过封装Client library来隐藏底层差异。

### 独立部署基础设施
运维团队需要对基础设施抽象接口提供一套独立部署的实现，其中要考虑硬件需求，性能指标，以及运维需求，如部署，升级，Patch，监控，故障恢复等等。

### 数据安全
独立部署不是一个完全封闭的黑盒子，它还要和SAAS公司的支撑服务进行交互，如运营平台，运维平台，以及其他不便独立部署的模块。公有云SAAS和独立部署属于不同的安全域，任何穿梭安全边界的数据都需要认证，
避免独立部署获取超越当前安全边界的权限；敏感数据需要加密。


